<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Half-Life Sound Catalog</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --surface: #2d2d2d;
            --border: #404040;
            --text: #e0e0e0;
            --text-muted: #888;
            --accent: #ff6b00;
            --accent-hover: #ff8533;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        h1 {
            margin: 0 0 20px;
            font-size: 1.8rem;
            color: var(--accent);
        }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input, select {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        #search {
            flex: 1;
            min-width: 200px;
        }

        .stats {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            text-align: left;
            padding: 12px 8px;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            font-weight: 500;
            position: sticky;
            top: 0;
            background: var(--bg);
            cursor: pointer;
            user-select: none;
        }

        th:hover { color: var(--accent); }
        th.sorted { color: var(--accent); }
        th.sorted::after { content: ' ▼'; }
        th.sorted.asc::after { content: ' ▲'; }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover { background: var(--surface); }

        .play-btn {
            background: var(--accent);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .play-btn:hover { background: var(--accent-hover); }
        .play-btn.playing { background: #e55; }

        .tag {
            display: inline-block;
            background: var(--surface);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            color: var(--text-muted);
        }

        .category {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .category-speech { background: #2d4a3e; color: #6bcf8e; }
        .category-creature { background: #4a2d3e; color: #cf6b8e; }
        .category-weapon { background: #4a3e2d; color: #cfaa6b; }
        .category-mechanical { background: #2d3e4a; color: #6b9ecf; }
        .category-explosion { background: #4a2d2d; color: #cf6b6b; }
        .category-ambient { background: #3e4a2d; color: #a8cf6b; }
        .category-music { background: #3e2d4a; color: #a86bcf; }
        .category-ui { background: #4a4a2d; color: #cfcf6b; }
        .category-footstep { background: #2d4a4a; color: #6bcfcf; }
        .category-other { background: #3a3a3a; color: #aaa; }

        .duration {
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        .file-path {
            font-family: monospace;
            font-size: 12px;
            color: var(--text-muted);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        #audio-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            padding: 12px 20px;
            display: none;
            align-items: center;
            gap: 16px;
            border-top: 1px solid var(--border);
        }

        #audio-player.active { display: flex; }

        #audio-player audio {
            flex: 1;
            height: 32px;
        }

        #now-playing {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        #close-player {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
        }

        #close-player:hover { color: var(--text); }

        @media (max-width: 768px) {
            .filters { flex-direction: column; }
            #search { min-width: 100%; }
            th, td { padding: 8px 4px; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body>
    <h1>Half-Life Sound Catalog</h1>

    <div class="filters">
        <input type="text" id="search" placeholder="Search sounds...">
        <select id="category-filter">
            <option value="">All Categories</option>
        </select>
        <select id="directory-filter">
            <option value="">All Directories</option>
        </select>
    </div>

    <div class="stats" id="stats">Loading...</div>

    <table>
        <thead>
            <tr>
                <th style="width: 50px;"></th>
                <th data-sort="file_name">Name</th>
                <th data-sort="ai_description">Description</th>
                <th data-sort="ai_category">Category</th>
                <th data-sort="duration_seconds" class="hide-mobile">Duration</th>
                <th data-sort="directory" class="hide-mobile">Directory</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <tr><td colspan="6" class="loading">Loading catalog...</td></tr>
        </tbody>
    </table>

    <div id="audio-player">
        <span id="now-playing"></span>
        <audio id="audio" controls></audio>
        <button id="close-player">&times;</button>
    </div>

    <script>
        let sounds = [];
        let filteredSounds = [];
        let sortCol = 'directory';
        let sortAsc = true;
        let currentlyPlaying = null;

        const baseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? '..'
            : 'https://raw.githubusercontent.com/elohmeier/hl1/master';

        async function loadCatalog() {
            const res = await fetch('catalog.csv');
            const text = await res.text();
            sounds = parseCSV(text);

            // Populate filters
            const categories = [...new Set(sounds.map(s => s.ai_category))].sort();
            const directories = [...new Set(sounds.map(s => s.directory))].sort();

            const catSelect = document.getElementById('category-filter');
            categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c.charAt(0).toUpperCase() + c.slice(1);
                catSelect.appendChild(opt);
            });

            const dirSelect = document.getElementById('directory-filter');
            directories.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                dirSelect.appendChild(opt);
            });

            applyFilters();
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            return lines.slice(1).map(line => {
                const values = parseCSVLine(line);
                const obj = {};
                headers.forEach((h, i) => obj[h] = values[i] || '');
                return obj;
            });
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function applyFilters() {
            const search = document.getElementById('search').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const directory = document.getElementById('directory-filter').value;

            filteredSounds = sounds.filter(s => {
                if (category && s.ai_category !== category) return false;
                if (directory && s.directory !== directory) return false;
                if (search) {
                    const searchable = `${s.file_name} ${s.ai_description} ${s.ai_tags} ${s.directory}`.toLowerCase();
                    if (!searchable.includes(search)) return false;
                }
                return true;
            });

            sortSounds();
            render();
        }

        function sortSounds() {
            filteredSounds.sort((a, b) => {
                let aVal = a[sortCol];
                let bVal = b[sortCol];

                if (sortCol === 'duration_seconds') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }

                if (aVal < bVal) return sortAsc ? -1 : 1;
                if (aVal > bVal) return sortAsc ? 1 : -1;
                return 0;
            });
        }

        function render() {
            document.getElementById('stats').textContent =
                `Showing ${filteredSounds.length} of ${sounds.length} sounds`;

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = filteredSounds.map((s, i) => `
                <tr>
                    <td>
                        <button class="play-btn" data-index="${i}" title="Play">▶</button>
                    </td>
                    <td>
                        <div>${escapeHtml(s.file_name)}</div>
                        <div class="file-path">${escapeHtml(s.file_path)}</div>
                    </td>
                    <td>
                        <div>${escapeHtml(s.ai_description)}</div>
                        <div>${(s.ai_tags || '').split('|').filter(t => t).map(t =>
                            `<span class="tag">${escapeHtml(t)}</span>`
                        ).join('')}</div>
                    </td>
                    <td>
                        <span class="category category-${s.ai_category}">${escapeHtml(s.ai_category)}</span>
                    </td>
                    <td class="duration hide-mobile">${formatDuration(s.duration_seconds)}</td>
                    <td class="hide-mobile">${escapeHtml(s.directory)}</td>
                </tr>
            `).join('');

            // Update sort indicators
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sorted', 'asc');
                if (th.dataset.sort === sortCol) {
                    th.classList.add('sorted');
                    if (sortAsc) th.classList.add('asc');
                }
            });
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function formatDuration(seconds) {
            const s = parseFloat(seconds) || 0;
            const mins = Math.floor(s / 60);
            const secs = (s % 60).toFixed(1);
            return mins > 0 ? `${mins}:${secs.padStart(4, '0')}` : `${secs}s`;
        }

        function playSound(index) {
            const sound = filteredSounds[index];
            const audio = document.getElementById('audio');
            const player = document.getElementById('audio-player');
            const nowPlaying = document.getElementById('now-playing');

            // Update button states
            document.querySelectorAll('.play-btn').forEach(btn => btn.classList.remove('playing'));
            document.querySelector(`.play-btn[data-index="${index}"]`)?.classList.add('playing');

            audio.src = `${baseUrl}/${sound.file_path}`;
            audio.play();

            nowPlaying.textContent = `${sound.file_name} - ${sound.ai_description}`;
            player.classList.add('active');
            currentlyPlaying = index;
        }

        // Event listeners
        document.getElementById('search').addEventListener('input', applyFilters);
        document.getElementById('category-filter').addEventListener('change', applyFilters);
        document.getElementById('directory-filter').addEventListener('change', applyFilters);

        document.querySelector('thead').addEventListener('click', e => {
            const th = e.target.closest('th[data-sort]');
            if (!th) return;

            if (sortCol === th.dataset.sort) {
                sortAsc = !sortAsc;
            } else {
                sortCol = th.dataset.sort;
                sortAsc = true;
            }
            sortSounds();
            render();
        });

        document.getElementById('table-body').addEventListener('click', e => {
            const btn = e.target.closest('.play-btn');
            if (btn) playSound(parseInt(btn.dataset.index));
        });

        document.getElementById('close-player').addEventListener('click', () => {
            document.getElementById('audio').pause();
            document.getElementById('audio-player').classList.remove('active');
            document.querySelectorAll('.play-btn').forEach(btn => btn.classList.remove('playing'));
        });

        document.getElementById('audio').addEventListener('ended', () => {
            document.querySelectorAll('.play-btn').forEach(btn => btn.classList.remove('playing'));
        });

        // Load catalog
        loadCatalog();
    </script>
</body>
</html>
